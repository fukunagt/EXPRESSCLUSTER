# 仮想 IP アドレスリソース (Linux)
- CLUSTERPRO X for Linux の仮想 IP アドレスリソース (以降、VIP と略) を仮想化環境で評価するためのメモです。

## 環境
```
                         +----------------------+
                         | client               |
                         |  MIRACLE LINUX 8.4   |
                         +----------+-----------+
                                    | 192.168.12.223
                                    | 
                                    | 192.168.12.220
+--------------------+   +----------+-----------+   +--------------------+
| server1            |   | router               |   | server2            |
|  MIRACLE LINUX 8.4 +---+  Windows Server 2022 +---+  MIRACLE LINUX 8.4 |
|  CLUTERPRO X 5.0   A   A                      A   A  CLUTERPRO X 5.0   |
+--------------------|   |----------------------|   |--------------------+
                     |   |                      |   |
         192.168.10.221  |                      |  192.168.11.222
                         |                      |
             192.168.10.220         192.168.11.220
```
- 上記図中のサブネットマスクは全て 255.255.255.0 とする。
- server1
  - デフォルトゲートウェイに 192.168.10.220 を設定。
<!--
    - もしくは、route add で 192.168.11.0/24 のゲートウェイに 192.168.10.220 を設定。
-->
- server2 
  - デフォルトゲートウェイに 192.168.11.220 を設定。
<!--
    - もしくは、route add で 192.168.10.0/24 のゲートウェイに 192.168.11.220 を設定。
-->    
- router
  - サーバマネージャにて [ルーティングとリモート アクセス] の機能を追加。
  - 以下を参考に RIP を有効にし、該当の NIC に対して RIP を有効にする。
    - 参考: https://forsenergy.com/ja-jp/rras/html/6bb9bb87-a8f9-4efd-8cfb-872d78008598.htm
    - [詳細設定] にて、以下にチェックを付ける。
      - 受信したアナウンスのホスト ルートを処理する
      - 受信したアナウンスの既定のルートを処理する
      - 参考: https://carroll.net/blog/rip-routing-on-windows/

## VIP の設定
- CLUSTERPRO の VIP のパラメータに以下を設定。
  - 共通
    - IP アドレス: 192.168.13.229
    - NIC エイリアス名: eth1 (以下の送信元 IP アドレスが付与されている NIC を指定)
    - 宛先 IP アドレス: 192.168.10.255
    - 送信元 IP アドレス: 192.168.10.221
    - ルーティングプロトコル: RIPver2
  - サーバ別設定 (server2)
    - 宛先 IP アドレス: 192.168.11.255
    - 送信元 IP アドレス: 192.168.11.222

## VIP 活性時のルートテーブル
- VIP 活性時の router のルートテーブルは以下のようになる。
### server1 で活性した場合
```
C:\>route print -4
===========================================================================
インターフェイス一覧
  2...00 15 5d 45 90 3e ......Microsoft Hyper-V Network Adapter
 10...00 15 5d 45 90 3f ......Microsoft Hyper-V Network Adapter #2
 15...00 15 5d 45 90 40 ......Microsoft Hyper-V Network Adapter #3
 27...00 15 5d 45 90 43 ......Microsoft Hyper-V Network Adapter #4
  1...........................Software Loopback Interface 1
===========================================================================

IPv4 ルート テーブル
===========================================================================
アクティブ ルート:
ネットワーク宛先        ネットマスク          ゲートウェイ       インターフェイス  メトリック
        127.0.0.0        255.0.0.0            リンク上         127.0.0.1    331
        127.0.0.1  255.255.255.255            リンク上         127.0.0.1    331
  127.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
      192.168.1.0    255.255.255.0            リンク上     192.168.1.220    271
    192.168.1.220  255.255.255.255            リンク上     192.168.1.220    271
    192.168.1.255  255.255.255.255            リンク上     192.168.1.220    271
     192.168.10.0    255.255.255.0            リンク上    192.168.10.220    271
   192.168.10.220  255.255.255.255            リンク上    192.168.10.220    271
   192.168.10.255  255.255.255.255            リンク上    192.168.10.220    271
     192.168.11.0    255.255.255.0            リンク上    192.168.11.220    271
   192.168.11.220  255.255.255.255            リンク上    192.168.11.220    271
   192.168.11.255  255.255.255.255            リンク上    192.168.11.220    271
     192.168.12.0    255.255.255.0            リンク上    192.168.12.220    271
   192.168.12.220  255.255.255.255            リンク上    192.168.12.220    271
   192.168.12.255  255.255.255.255            リンク上    192.168.12.220    271
   192.168.13.229  255.255.255.255   192.168.10.221   192.168.10.220     17
        224.0.0.0        240.0.0.0            リンク上         127.0.0.1    331
        224.0.0.0        240.0.0.0            リンク上     192.168.1.220    271
        224.0.0.0        240.0.0.0            リンク上    192.168.10.220    271
        224.0.0.0        240.0.0.0            リンク上    192.168.11.220    271
        224.0.0.0        240.0.0.0            リンク上    192.168.12.220    271
  255.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
  255.255.255.255  255.255.255.255            リンク上     192.168.1.220    271
  255.255.255.255  255.255.255.255            リンク上    192.168.10.220    271
  255.255.255.255  255.255.255.255            リンク上    192.168.11.220    271
  255.255.255.255  255.255.255.255            リンク上    192.168.12.220    271
===========================================================================
固定ルート:
  なし
```
### server2 で活性した場合
```
C:\>route print -4
===========================================================================
インターフェイス一覧
  2...00 15 5d 45 90 3e ......Microsoft Hyper-V Network Adapter
 10...00 15 5d 45 90 3f ......Microsoft Hyper-V Network Adapter #2
 15...00 15 5d 45 90 40 ......Microsoft Hyper-V Network Adapter #3
 27...00 15 5d 45 90 43 ......Microsoft Hyper-V Network Adapter #4
  1...........................Software Loopback Interface 1
===========================================================================

IPv4 ルート テーブル
===========================================================================
アクティブ ルート:
ネットワーク宛先        ネットマスク          ゲートウェイ       インターフェイス  メトリック
        127.0.0.0        255.0.0.0            リンク上         127.0.0.1    331
        127.0.0.1  255.255.255.255            リンク上         127.0.0.1    331
  127.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
      192.168.1.0    255.255.255.0            リンク上     192.168.1.220    271
    192.168.1.220  255.255.255.255            リンク上     192.168.1.220    271
    192.168.1.255  255.255.255.255            リンク上     192.168.1.220    271
     192.168.10.0    255.255.255.0            リンク上    192.168.10.220    271
   192.168.10.220  255.255.255.255            リンク上    192.168.10.220    271
   192.168.10.255  255.255.255.255            リンク上    192.168.10.220    271
     192.168.11.0    255.255.255.0            リンク上    192.168.11.220    271
   192.168.11.220  255.255.255.255            リンク上    192.168.11.220    271
   192.168.11.255  255.255.255.255            リンク上    192.168.11.220    271
     192.168.12.0    255.255.255.0            リンク上    192.168.12.220    271
   192.168.12.220  255.255.255.255            リンク上    192.168.12.220    271
   192.168.12.255  255.255.255.255            リンク上    192.168.12.220    271
   192.168.13.229  255.255.255.255   192.168.11.222   192.168.11.220     17
        224.0.0.0        240.0.0.0            リンク上         127.0.0.1    331
        224.0.0.0        240.0.0.0            リンク上     192.168.1.220    271
        224.0.0.0        240.0.0.0            リンク上    192.168.10.220    271
        224.0.0.0        240.0.0.0            リンク上    192.168.11.220    271
        224.0.0.0        240.0.0.0            リンク上    192.168.12.220    271
  255.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
  255.255.255.255  255.255.255.255            リンク上     192.168.1.220    271
  255.255.255.255  255.255.255.255            リンク上    192.168.10.220    271
  255.255.255.255  255.255.255.255            リンク上    192.168.11.220    271
  255.255.255.255  255.255.255.255            リンク上    192.168.12.220    271
===========================================================================
固定ルート:
  なし
```

### 動作確認
- client から VIP に設定したアドレス 192.168.13.229 に対して ping を実行し、応答があることを確認。
- グループ移動後も同じアドレスに対して ping を実行し、応答があることを確認。